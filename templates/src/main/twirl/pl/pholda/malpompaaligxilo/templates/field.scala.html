@import pl.pholda.malpompaaligxilo.form.field.calculateField.cost.CostsField
@(field: pl.pholda.malpompaaligxilo.form.Field[_])(implicit form: pl.pholda.malpompaaligxilo.form.FormInstanceJVM[_], lang: pl.pholda.malpompaaligxilo.i18n.Lang = "en")
@import pl.pholda.malpompaaligxilo.form.field.calculateField.ProgressField
@import pl.pholda.malpompaaligxilo.form.field.{CheckboxField, CheckboxTableField, ComputeField, DateField, EmailField, EnumOption, IntField, SelectField, StringField}
@{
    field.`type` match {
        case StringField(false, default) =>
            <input type="text"
                ng-model={"fieldValue['"+field.name+"']"}
                name={field.name}
                class="form-control"
                ng-disabled="submitted"
                placeholder={field.placeholder.map(_(lang)) orNull}
                value={field.value.map(_.toString).orElse(default) orNull}
                required={if (field.required) "required" else null}
                />
        case StringField(true, default) =>
            <textarea
            ng-model={"fieldValue['"+field.name+"']"}
            name={field.name}
            class="form-control"
            ng-disabled="submitted"
            placeholder={field.placeholder.map(_(lang)) orNull}
            required={if (field.required) "required" else null}>{field.value.map(_.toString).orElse(default) orNull}</textarea>
        case IntField(min, max, step) =>
            <input type="number"
                ng-model={"fieldValue['"+field.name+"']"}
                name={field.name}
                class="form-control"
                ng-disabled="submitted"
                placeholder={field.placeholder.map(_(lang)) orNull}
                min={min.map(_.toString) orNull}
                max={max.map(_.toString) orNull}
                step={step.map(_.toString) orNull}
                value={field.value.map(_.toString).orNull}
                required={if (field.required) "required" else null}
                />
        case DateField(minDate, maxDate, yearRange) =>
            <input ui-date="dateOptions" type="text"
                ng-model={"fieldValue['"+field.name+"']"}
                name={field.name}
                class="form-control formDate"
                ng-disabled="submitted"
                ui-date-format="yy-mm-dd"
                data-mindate={minDate.map(_.toString) orNull}
                data-maxdate={maxDate.map(_.toString) orNull}
                data-yearrange={yearRange orNull}
                placeholder={field.placeholder.map(_(lang)) orNull}
                value={field.value.map(_.toString).orNull}
                required={if (field.required) "required" else null}
                />
        case pf: ProgressField =>
//            <div class="progressField" data-name={field.name}></div>
            <progress
                ng-model={"fieldValue['"+field.name+"']"}
                data-name={field.name}
                ng-disabled="submitted"
                value={pf.value(form).toString}
                max={pf.max(form).toString}
            />
        case costsField: CostsField =>
            <span ng-bind-html={s"computedValue('${field.name}')"}></span>
        case cf: ComputeField[_] =>
            <span>{s"{{computedValue('${field.name}')}}"}</span>
            //TODO ordering@selectField
        case s@SelectField(_, size, _, orderingOpt) =>
            //workaround
            <input type="hidden" name={field.name} value={"{{fieldValue['"+field.name+"']}}"}/>
            <select size={size.toString}
                ng-model={"fieldValue['"+field.name+"']"}
                required={if (field.required) "required" else null}
                class="form-control">{
                val ordered = orderingOpt match {
                    case Some(ordering) =>
                        s.allOptionsIndexed.toList.sortWith(ordering.ordering(s))
                    case _ =>
                        s.allOptionsIndexed.toList
                }
                ordered.map{ case (idx, option) =>
                    <option
                    value={idx.toString}
                    selected={
                    field.value match {
                        case Some(EnumOption(fval, _)) if fval == option.value => "selected"
                        case _ => null
                    }
                    }
                    ng-disabled="submitted"
                    >{option.caption(lang)}</option>
                }
            }</select>
        case EmailField =>
            <input type="email"
                ng-model={"fieldValue['"+field.name+"']"}
                name={field.name}
                placeholder={field.placeholder.map(_(lang)) orNull}
                class="form-control"
                ng-disabled="submitted"
                value={field.value.map(_.toString).orNull}
                required={if (field.required) "required" else null}/>
        case tfield@CheckboxTableField(rows, cols, disabled, default) if cols.size == 1 =>
            <table data-name={field.name}>{
            rows.map { row =>
                <tr><td>
                <label for={field.name + "-" + row.id}>{row.caption(lang)}</label>
                </td><td>
                <input type="checkbox"
                    class="form-control"
                    id={field.name + "-" + row.id}
                    name={field.name+"[]"}
                    value={row.id + "-" + cols.head.id}
                    ng-disabled="submitted"
                    checked={
                    field.value match {
                        case Some(CheckboxTableField.Result(values))
                            if values.contains((row, cols.head)) => "checked"
                        case _ if !form.isFilled && default => "checked"
                        case _ => null
                    }
                    }
                    ng-model={"fieldValue['"+field.name+"'][]"}
                    />
                </td></tr>
            }
            }</table>
        case tfield@CheckboxTableField(rows, cols, disabled, default) =>
            <table data-name={field.name}>
            <tr><td></td>{
                cols.map { col =>
                    <th>{col.caption(lang)}</th>
                }
            }</tr>
            {
            rows.map { row =>
                <tr><td>
                <label for={field.name + "-" + row.id}>{row.caption(lang)}</label>
                </td>{
                cols.map {col =>
                    <td>{
                        if (!tfield.isDisabled(row, col)) {
                            <input type="checkbox"
                            class="form-control"
                            id={field.name + "-" + col.id + "-" + row.id}
                            name={field.name+"[]"}
                            ng-disabled="submitted"
                            value={row.id + "-" + col.id}
                            checked={
                            field.value match {
                                case Some(CheckboxTableField.Result(values))
                                    if values.contains((row, cols.head)) => "checked"
                                case _ if !form.isFilled && default => "checked"
                                case _ => null
                            }
                            }
                            ng-model={s"fieldValue['${field.name}']['${row.id}-${col.id}']"}
                            />
                        }
                    }
                    </td>
                }}
                </tr>
            }
            }</table>
        case CheckboxField(default) =>
            <input type="checkbox"
                ng-model={"fieldValue['"+field.name+"']"}
                name={field.name}
                checked={
                field.value match {
                    case None if default => "checked"
                    case Some(true) => "checked"
                    case _ => null
                }
                }
                class="form-control"
                ng-disabled="submitted"
                id={field.name}
                required={if (field.required) "required" else null}/>
        case x => Html(s"unrecognized field!! $x")
    }
}